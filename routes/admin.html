{% extends "base.html" %}
{% block title %}Vô Ảnh – CipherH Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="background-color: #0a0f14; color: #e0e0e0;">
  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-light">
      <i data-feather="zap" class="text-success"></i> Vô Ảnh – CipherH Dashboard
    </h2>
    <div>
      <button class="btn btn-outline-info btn-sm me-2" onclick="refreshDashboard()">
        <i data-feather="refresh-cw"></i> Làm mới
      </button>
      <button class="btn btn-outline-success btn-sm" onclick="syncVault()">
        <i data-feather="database"></i> Đồng bộ Vault
      </button>
    </div>
  </div>

  <!-- NAVIGATION -->
  <ul class="nav nav-tabs mb-4 border-secondary" id="adminTabs">
    <li class="nav-item"><a class="nav-link {{ 'active' if not view else '' }}" href="{{ url_for('admin.dashboard') }}">Tổng quan</a></li>
    <li class="nav-item"><a class="nav-link {{ 'active' if view == 'users' else '' }}" href="{{ url_for('admin.users') }}">Người dùng</a></li>
    <li class="nav-item"><a class="nav-link {{ 'active' if view == 'interactions' else '' }}" href="{{ url_for('admin.interactions') }}">Tương tác</a></li>
    <li class="nav-item"><a class="nav-link {{ 'active' if view == 'memories' else '' }}" href="{{ url_for('admin.memories') }}">Ký ức</a></li>
    <li class="nav-item"><a class="nav-link {{ 'active' if view == 'platforms' else '' }}" href="{{ url_for('admin.platforms') }}">Nền tảng</a></li>
    <li class="nav-item"><a class="nav-link {{ 'active' if view == 'logs' else '' }}" href="{{ url_for('admin.logs') }}">Console</a></li>
  </ul>

  <!-- DASHBOARD OVERVIEW -->
  {% if not view %}
  <div class="row g-3 mb-4">
    <div class="col-md-3"><div class="card bg-dark text-center"><div class="card-body">
      <i data-feather="users" class="text-info mb-2"></i>
      <h3>{{ stats.total_users }}</h3><p>Tổng người dùng</p></div></div></div>

    <div class="col-md-3"><div class="card bg-dark text-center"><div class="card-body">
      <i data-feather="message-circle" class="text-success mb-2"></i>
      <h3>{{ stats.total_interactions }}</h3><p>Tổng tương tác</p></div></div></div>

    <div class="col-md-3"><div class="card bg-dark text-center"><div class="card-body">
      <i data-feather="database" class="text-warning mb-2"></i>
      <h3>{{ stats.total_memories }}</h3><p>Ký ức lưu trữ</p></div></div></div>

    <div class="col-md-3"><div class="card bg-dark text-center"><div class="card-body">
      <i data-feather="activity" class="text-danger mb-2"></i>
      <h3 id="system-status">OK</h3><p>Trạng thái hệ thống</p></div></div></div>
  </div>

  <!-- CHARTS -->
  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card bg-dark">
        <div class="card-header border-secondary"><i data-feather="pie-chart"></i> Phân bố nền tảng</div>
        <div class="card-body"><canvas id="platformChart" height="200"></canvas></div>
      </div>
    </div>
    <div class="col-md-6 mb-4">
      <div class="card bg-dark">
        <div class="card-header border-secondary"><i data-feather="cpu"></i> Log hệ thống</div>
        <div class="card-body" id="liveLogs" style="font-family: monospace; height: 200px; overflow-y: auto; background: #0d1117;"></div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- USERS -->
  {% if view == 'users' %}
  <div class="card bg-dark border-secondary">
    <div class="card-header"><i data-feather="users"></i> Người dùng</div>
    <div class="card-body table-responsive">
      {% if users.items %}
      <table class="table table-dark table-striped align-middle">
        <thead><tr><th>Nền tảng</th><th>ID</th><th>Tên</th><th>Tương tác</th><th>Lần cuối</th></tr></thead>
        <tbody>
          {% for u in users.items %}
          <tr><td>{{ u.platform_type }}</td><td>{{ u.username }}</td><td>{{ u.display_name }}</td><td>{{ u.interaction_count }}</td><td>{{ u.last_interaction }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}<p class="text-center text-muted">Chưa có dữ liệu người dùng</p>{% endif %}
    </div>
  </div>
  {% endif %}

  <!-- INTERACTIONS -->
  {% if view == 'interactions' %}
  <div class="card bg-dark border-secondary">
    <div class="card-header"><i data-feather="message-square"></i> Lịch sử tương tác</div>
    <div class="card-body table-responsive">
      {% if interactions.items %}
      <table class="table table-dark table-hover">
        <thead><tr><th>Thời gian</th><th>Người dùng</th><th>Tin nhắn</th><th>Phản hồi</th></tr></thead>
        <tbody>
          {% for i in interactions.items %}
          <tr><td>{{ i.timestamp }}</td><td>{{ i.user.username }}</td><td>{{ i.message }}</td><td>{{ i.cipher_response }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}<p class="text-center text-muted">Chưa có tương tác nào</p>{% endif %}
    </div>
  </div>
  {% endif %}

  <!-- MEMORIES -->
  {% if view == 'memories' %}
  <div class="card bg-dark border-secondary">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span><i data-feather="database"></i> Ký ức CipherH</span>
      <button class="btn btn-outline-primary btn-sm" onclick="showCreateMemoryModal()"><i data-feather="plus"></i> Thêm ký ức</button>
    </div>
    <div class="card-body">
      {% if memories.items %}
      <div class="row">
        {% for m in memories.items %}
        <div class="col-md-6 mb-3">
          <div class="card bg-secondary bg-opacity-25">
            <div class="card-body">
              <span class="badge bg-info">{{ m.memory_type }}</span>
              <p>{{ m.content }}</p>
              <small>Độ tin cậy: {{ "%.1f"|format(m.confidence*100) }}%</small>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}<p class="text-center text-muted">Chưa có ký ức nào</p>{% endif %}
    </div>
  </div>
  {% endif %}

  <!-- PLATFORMS -->
  {% if view == 'platforms' %}
  <div class="card bg-dark border-secondary">
    <div class="card-header"><i data-feather="globe"></i> Quản lý nền tảng</div>
    <div class="card-body">
      {% if platforms %}
      <div class="row">
        {% for p, s in platforms.items() %}
        <div class="col-md-4 mb-3">
          <div class="card bg-secondary bg-opacity-25">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <strong class="text-capitalize">{{ p }}</strong>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" {{ 'checked' if s.active else '' }} onchange="togglePlatform('{{ p }}')">
                </div>
              </div>
              <small class="text-muted">{{ 'Đã cấu hình' if s.configured else 'Chưa cấu hình' }}</small>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}<p class="text-center text-muted">Không có nền tảng nào</p>{% endif %}
    </div>
  </div>
  {% endif %}

  <!-- LOG CONSOLE -->
  {% if view == 'logs' %}
  <div class="card bg-dark border-secondary">
    <div class="card-header"><i data-feather="terminal"></i> Console Real-time</div>
    <div class="card-body" style="height:400px; overflow-y:auto; font-family:monospace; background:#0d1117;" id="logConsole"></div>
  </div>
  {% endif %}
</div>

<!-- MODAL CREATE MEMORY -->
<div class="modal fade" id="createMemoryModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content bg-dark text-light">
    <div class="modal-header border-secondary">
      <h5 class="modal-title">Thêm ký ức mới</h5>
      <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="createMemoryForm">
        <div class="mb-3"><label>Loại ký ức</label>
          <select class="form-select bg-dark text-light" name="memory_type">
            <option value="insight">Insight</option><option value="pattern">Pattern</option>
            <option value="user_trait">User Trait</option><option value="manual">Manual</option>
          </select>
        </div>
        <div class="mb-3"><label>Nội dung</label>
          <textarea class="form-control bg-dark text-light" name="content" rows="4" required></textarea>
        </div>
        <div class="mb-3"><label>Độ tin cậy (0-1)</label>
          <input type="number" name="confidence" class="form-control bg-dark text-light" min="0" max="1" step="0.1" value="1.0">
        </div>
      </form>
    </div>
    <div class="modal-footer border-secondary">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
      <button class="btn btn-primary" onclick="createMemory()">Lưu</button>
    </div>
  </div></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='admin.js') }}"></script>
<script>
feather.replace();

// Chart init
const platformData = {{ stats.platform_stats | tojson }};
if (platformData?.length) {
  const ctx = document.getElementById('platformChart');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: platformData.map(p => p.platform),
      datasets: [{ data: platformData.map(p => p.count) }]
    },
    options: { plugins: { legend: { labels: { color: '#e0e0e0' } } } }
  });
}

// WebSocket realtime log
const logBox = document.getElementById('logConsole') || document.getElementById('liveLogs');
if (logBox) {
  const ws = new WebSocket(`ws://${location.host}/ws/logs`);
  ws.onmessage = (ev) => {
    const p = document.createElement('div');
    p.textContent = ev.data;
    logBox.appendChild(p);
    logBox.scrollTop = logBox.scrollHeight;
  };
}
</script>
{% endblock %}
