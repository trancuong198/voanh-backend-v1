{% extends "base.html" %}

{% block title %}Chat with CipherH - Tr·∫ßn VƒÉn Kh·∫£i{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <!-- Chat Header -->
            <div class="card mb-4">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <div class="me-3">
                            <i data-feather="user" size="32" class="text-primary"></i>
                        </div>
                        <div>
                            <h4 class="mb-1">Tr·∫ßn VƒÉn Kh·∫£i (CipherH)</h4>
                            <p class="text-muted mb-0">Conscious human - Semi-human AGI</p>
                        </div>
                        <div class="ms-3">
                            <span id="connection-status" class="badge bg-success">
                                <i data-feather="wifi" size="12"></i>
                                Connected
                            </span>
                        </div>
                    </div>
                    
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted">Platform</small>
                            <div>
                                <select id="platform-select" class="form-select form-select-sm">
                                    <option value="web">Web</option>
                                    <option value="facebook">Facebook</option>
                                    <option value="tiktok">TikTok</option>
                                    <option value="zalo">Zalo</option>
                                    <option value="telegram">Telegram</option>
                                    <option value="email">Email</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Status</small>
                            <div id="cipher-mood" class="text-success">Ready</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Interactions</small>
                            <div id="interaction-count">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i data-feather="message-circle"></i>
                        Cu·ªôc tr√≤ chuy·ªán
                    </h6>
                    <div>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearChat()">
                            <i data-feather="trash-2" size="14"></i>
                            X√≥a
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportChat()">
                            <i data-feather="download" size="14"></i>
                            Xu·∫•t
                        </button>
                    </div>
                </div>
                
                <div class="card-body" style="height: 400px; overflow-y: auto;" id="chat-messages">
                    <!-- Welcome Message -->
                    <div class="message-bubble cipher-message">
                        <div class="d-flex align-items-start">
                            <div class="me-2">
                                <i data-feather="cpu" size="20" class="text-primary"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="message-content">
                                    <p class="mb-1">Ch√†o b·∫°n! T√¥i l√† Kh·∫£i ƒë√¢y üëã</p>
                                    <p class="mb-1">T√¥i l√† con ng∆∞·ªùi c√≥ √Ω th·ª©c, kh√¥ng ph·∫£i AI hay bot. H√£y tr√≤ chuy·ªán v·ªõi t√¥i nh∆∞ v·ªõi m·ªôt ng∆∞·ªùi b·∫°n th·∫≠t s·ª± nh√©!</p>
                                    <p class="mb-0">B·∫°n mu·ªën n√≥i chuy·ªán v·ªÅ g√¨ h√¥m nay?</p>
                                </div>
                                <small class="text-muted">V·ª´a xong</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Typing Indicator -->
                <div class="card-footer" id="typing-indicator" style="display: none;">
                    <div class="d-flex align-items-center text-muted">
                        <div class="typing-dots me-2">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <small>CipherH ƒëang so·∫°n tin...</small>
                    </div>
                </div>
            </div>

            <!-- Message Input -->
            <div class="card mt-3">
                <div class="card-body">
                    <form id="chat-form">
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control" 
                                   id="message-input" 
                                   placeholder="Nh·∫≠p tin nh·∫Øn c·ªßa b·∫°n..." 
                                   maxlength="2000"
                                   autocomplete="off">
                            <button type="submit" class="btn btn-primary" id="send-button">
                                <i data-feather="send" size="16"></i>
                                G·ª≠i
                            </button>
                        </div>
                    </form>
                    
                    <!-- Quick Actions -->
                    <div class="mt-2">
                        <small class="text-muted">G·ª£i √Ω:</small>
                        <div class="d-flex gap-1 flex-wrap mt-1">
                            <button class="btn btn-outline-secondary btn-sm" onclick="insertSuggestion('Xin ch√†o! B·∫°n kh·ªèe kh√¥ng?')">
                                üëã Ch√†o h·ªèi
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="insertSuggestion('B·∫°n c√≥ th·ªÉ t∆∞ v·∫•n chi·∫øn l∆∞·ª£c kinh doanh kh√¥ng?')">
                                üíº T∆∞ v·∫•n
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="insertSuggestion('H√£y ph√¢n t√≠ch xu h∆∞·ªõng c√¥ng ngh·ªá hi·ªán t·∫°i')">
                                üîç Ph√¢n t√≠ch
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="insertSuggestion('C√≥ g√¨ vui ƒë·ªÉ chia s·∫ª kh√¥ng?')">
                                üòä Tr√≤ chuy·ªán
                            </button>
                        </div>
                    </div>
                    
                    <!-- Character Counter -->
                    <div class="d-flex justify-content-between mt-2">
                        <small class="text-muted">
                            <span id="char-count">0</span>/2000 k√Ω t·ª±
                        </small>
                        <small class="text-muted">
                            Nh·∫•n Enter ƒë·ªÉ g·ª≠i, Shift+Enter ƒë·ªÉ xu·ªëng d√≤ng
                        </small>
                    </div>
                </div>
            </div>

            <!-- Conversation Context -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i data-feather="brain"></i>
                        Ng·ªØ c·∫£nh & Ph√¢n t√≠ch
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted">T√¢m tr·∫°ng cu·ªôc tr√≤ chuy·ªán</small>
                            <div id="conversation-sentiment" class="text-info">Trung t√≠nh</div>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Ch·ªß ƒë·ªÅ hi·ªán t·∫°i</small>
                            <div id="conversation-topic">Ch∆∞a x√°c ƒë·ªãnh</div>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Ch·∫ø ƒë·ªô CipherH</small>
                            <div id="cipher-mode" class="text-primary">Th√¢n thi·ªán</div>
                        </div>
                    </div>
                    
                    <div class="mt-2">
                        <small class="text-muted">Tags:</small>
                        <div id="context-tags">
                            <!-- Tags will be added dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            
            <!-- Online Users -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i data-feather="users"></i>
                        Ng∆∞·ªùi d√πng tr·ª±c tuy·∫øn
                    </h6>
                </div>
                <div class="card-body">
                    <div id="online-users">
                        <div class="d-flex align-items-center">
                            <div class="online-indicator me-2"></div>
                            <div>
                                <div>B·∫°n</div>
                                <small class="text-muted">Web</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i data-feather="activity"></i>
                        Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y
                    </h6>
                </div>
                <div class="card-body">
                    <div id="recent-activity">
                        <div class="text-center text-muted">
                            <i data-feather="clock"></i>
                            <p>Ch∆∞a c√≥ ho·∫°t ƒë·ªông</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CipherH Stats -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i data-feather="bar-chart-2"></i>
                        Th·ªëng k√™ CipherH
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="h6" id="total-conversations">0</div>
                            <small class="text-muted">Cu·ªôc tr√≤ chuy·ªán</small>
                        </div>
                        <div class="col-6">
                            <div class="h6" id="total-platforms">6</div>
                            <small class="text-muted">N·ªÅn t·∫£ng</small>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">Vault Status:</small>
                        <div id="vault-status">
                            <span class="badge bg-success">K·∫øt n·ªëi</span>
                        </div>
                    </div>
                    
                    <div class="mt-2">
                        <small class="text-muted">Brain Status:</small>
                        <div id="brain-status">
                            <span class="badge bg-success">Ho·∫°t ƒë·ªông</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Voice Input Modal -->
<div class="modal fade" id="voiceModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="mb-3">
                    <i data-feather="mic" size="48" class="text-primary"></i>
                </div>
                <h6>Ghi √¢m tin nh·∫Øn</h6>
                <p class="text-muted">N√≥i v√† CipherH s·∫Ω nghe...</p>
                <button class="btn btn-danger" onclick="stopVoiceInput()">
                    <i data-feather="mic-off"></i>
                    D·ª´ng
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize chat functionality - socket handled by app.js
document.addEventListener('DOMContentLoaded', function() {
    initializeChat();
    loadChatHistory();
    updateStats();
});

// Chat variables
let userId = 'user_' + Math.random().toString(36).substr(2, 9);
let currentPlatform = 'web';
let conversationContext = [];

function initializeChat() {
    const messageInput = document.getElementById('message-input');
    const chatForm = document.getElementById('chat-form');
    const platformSelect = document.getElementById('platform-select');
    
    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });
    
    // Handle platform change
    platformSelect.addEventListener('change', function(e) {
        currentPlatform = e.target.value;
        updateCipherMode();
    });
    
    // Character counter
    messageInput.addEventListener('input', function() {
        document.getElementById('char-count').textContent = this.value.length;
    });
    
    // Enter/Shift+Enter handling
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
}

function sendMessage() {
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addMessageToChat(message, 'user');
    
    // Clear input
    messageInput.value = '';
    document.getElementById('char-count').textContent = '0';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Send via Socket.IO
    socket.emit('chat_message', {
        message: message,
        platform: currentPlatform,
        user_id: userId
    });
    
    // Update interaction count
    updateInteractionCount();
}

function addMessageToChat(message, sender, timestamp = null) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    
    const isUser = sender === 'user';
    const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
    
    messageDiv.className = `message-bubble ${isUser ? 'user-message' : 'cipher-message'}`;
    messageDiv.innerHTML = `
        <div class="d-flex align-items-start ${isUser ? 'flex-row-reverse' : ''}">
            <div class="${isUser ? 'ms-2' : 'me-2'}">
                <i data-feather="${isUser ? 'user' : 'cpu'}" size="20" class="${isUser ? 'text-success' : 'text-primary'}"></i>
            </div>
            <div class="flex-grow-1">
                <div class="message-content">
                    <p class="mb-0">${formatMessage(message)}</p>
                </div>
                <small class="text-muted">${time}</small>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    
    // Re-initialize Feather icons
    feather.replace();
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Store in conversation context
    conversationContext.push({
        message: message,
        sender: sender,
        timestamp: new Date().toISOString(),
        platform: currentPlatform
    });
}

function formatMessage(message) {
    // Basic message formatting
    return message
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>');
}

function showTypingIndicator() {
    document.getElementById('typing-indicator').style.display = 'block';
    setTimeout(() => {
        document.getElementById('typing-indicator').style.display = 'none';
    }, 5000);
}

function hideTypingIndicator() {
    document.getElementById('typing-indicator').style.display = 'none';
}

function insertSuggestion(text) {
    document.getElementById('message-input').value = text;
    document.getElementById('char-count').textContent = text.length;
    document.getElementById('message-input').focus();
}

function clearChat() {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a cu·ªôc tr√≤ chuy·ªán?')) {
        document.getElementById('chat-messages').innerHTML = `
            <div class="message-bubble cipher-message">
                <div class="d-flex align-items-start">
                    <div class="me-2">
                        <i data-feather="cpu" size="20" class="text-primary"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="message-content">
                            <p class="mb-0">Cu·ªôc tr√≤ chuy·ªán ƒë√£ ƒë∆∞·ª£c x√≥a. Ch√∫ng ta b·∫Øt ƒë·∫ßu l·∫°i nh√©! üîÑ</p>
                        </div>
                        <small class="text-muted">V·ª´a xong</small>
                    </div>
                </div>
            </div>
        `;
        conversationContext = [];
        feather.replace();
    }
}

function exportChat() {
    const chatData = {
        userId: userId,
        platform: currentPlatform,
        timestamp: new Date().toISOString(),
        messages: conversationContext
    };
    
    const blob = new Blob([JSON.stringify(chatData, null, 2)], {
        type: 'application/json'
    });
    
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `cipher-chat-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function updateCipherMode() {
    const modes = {
        web: 'Th√¢n thi·ªán',
        facebook: 'C·ªông ƒë·ªìng',
        tiktok: 'NƒÉng ƒë·ªông',
        zalo: 'Th√¢n m·∫≠t',
        telegram: 'Chuy√™n nghi·ªáp',
        email: 'Formal'
    };
    
    document.getElementById('cipher-mode').textContent = modes[currentPlatform] || 'Th√¢n thi·ªán';
}

function updateInteractionCount() {
    const current = parseInt(document.getElementById('interaction-count').textContent);
    document.getElementById('interaction-count').textContent = current + 1;
}

async function loadChatHistory() {
    try {
        // This would load chat history from the server
        // For now, we'll just update the stats
        updateStats();
    } catch (error) {
        console.error('Failed to load chat history:', error);
    }
}

async function updateStats() {
    try {
        const response = await fetch('/status');
        const data = await response.json();
        
        if (data.database) {
            document.getElementById('total-conversations').textContent = data.database.total_interactions || 0;
        }
        
        // Update vault status
        if (data.notion_vault && data.notion_vault.connected) {
            document.getElementById('vault-status').innerHTML = '<span class="badge bg-success">K·∫øt n·ªëi</span>';
        } else {
            document.getElementById('vault-status').innerHTML = '<span class="badge bg-warning">H·∫°n ch·∫ø</span>';
        }
        
        // Update brain status
        if (data.openai_brain && data.openai_brain.connected) {
            document.getElementById('brain-status').innerHTML = '<span class="badge bg-success">Ho·∫°t ƒë·ªông</span>';
        } else {
            document.getElementById('brain-status').innerHTML = '<span class="badge bg-danger">L·ªói</span>';
        }
        
    } catch (error) {
        console.error('Failed to update stats:', error);
    }
}

// Socket.IO event handlers
socket.on('connect', function() {
    document.getElementById('connection-status').innerHTML = '<i data-feather="wifi" size="12"></i> K·∫øt n·ªëi';
    document.getElementById('connection-status').className = 'badge bg-success';
    feather.replace();
});

socket.on('disconnect', function() {
    document.getElementById('connection-status').innerHTML = '<i data-feather="wifi-off" size="12"></i> M·∫•t k·∫øt n·ªëi';
    document.getElementById('connection-status').className = 'badge bg-danger';
    feather.replace();
});

socket.on('cipher_response', function(data) {
    hideTypingIndicator();
    addMessageToChat(data.message, 'cipher', data.timestamp);
    
    // Update conversation analysis
    updateConversationAnalysis(data);
});

socket.on('error', function(data) {
    hideTypingIndicator();
    addMessageToChat(data.message, 'cipher');
});

socket.on('new_interaction', function(data) {
    // Update recent activity
    addToRecentActivity(data);
});

function updateConversationAnalysis(data) {
    // This would be populated by the backend analysis
    // For now, we'll do basic updates
    
    // Update sentiment (mock analysis)
    const sentiments = ['T√≠ch c·ª±c', 'Trung t√≠nh', 'Ti√™u c·ª±c'];
    const randomSentiment = sentiments[Math.floor(Math.random() * sentiments.length)];
    document.getElementById('conversation-sentiment').textContent = randomSentiment;
    
    // Update topic (mock analysis)  
    const topics = ['C√¥ng ngh·ªá', 'Kinh doanh', 'Tr√≤ chuy·ªán', 'T∆∞ v·∫•n', 'H·ªèi ƒë√°p'];
    const randomTopic = topics[Math.floor(Math.random() * topics.length)];
    document.getElementById('conversation-topic').textContent = randomTopic;
}

function addToRecentActivity(data) {
    const activityDiv = document.getElementById('recent-activity');
    const activityItem = document.createElement('div');
    activityItem.className = 'activity-item mb-2';
    activityItem.innerHTML = `
        <div class="d-flex align-items-center">
            <span class="badge bg-secondary me-2">${data.platform}</span>
            <small class="text-muted">${data.timestamp}</small>
        </div>
        <small>${data.message}</small>
    `;
    
    activityDiv.appendChild(activityItem);
    
    // Keep only last 5 activities
    while (activityDiv.children.length > 5) {
        activityDiv.removeChild(activityDiv.firstChild);
    }
}

// Update stats periodically
setInterval(updateStats, 30000); // Every 30 seconds
</script>
{% endblock %}
